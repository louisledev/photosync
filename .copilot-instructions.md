## Project Context

This is an Azure Functions application that syncs photos from multiple OneDrive personal accounts to a single destination OneDrive. It uses:
- .NET 9.0 with C# 12
- Azure Functions (Timer-triggered)
- Microsoft Graph API for OneDrive access
- Azure Table Storage for state tracking
- Refresh token authentication for personal Microsoft accounts
- Two separate Function Apps for complete isolation

## Key Architecture Principles

1. **Two Function Apps**: Each source OneDrive has its own Function App for complete isolation
2. **Personal Accounts Only**: Uses refresh tokens, not client credentials (tenant = "common")
3. **State Tracking**: Azure Table Storage tracks processed files to prevent duplicates
4. **Modular Design**: Terraform modules allow easy scaling to more source accounts

## Coding Standards

### C# Guidelines
- Use nullable reference types (enabled in all projects)
- Prefer async/await for all I/O operations
- Use dependency injection for all services
- Follow Microsoft's C# coding conventions
- Keep methods focused and single-purpose
- Add XML documentation for public APIs

### Error Handling
- Log all exceptions with context using ILogger
- Use Application Insights for monitoring
- Fail gracefully - don't crash the entire sync on one file error
- Return meaningful error messages for configuration issues

### Testing
- Write unit tests for all business logic (xUnit + Moq)
- Use integration tests for Azure Table Storage (Testcontainers)
- Aim for high coverage but focus on critical paths
- Keep tests fast and independent

### Configuration
- Store secrets in Azure Key Vault (NOT in app settings)
- Use managed identity for Key Vault access
- Validate all configuration at startup
- Provide clear error messages for missing/invalid config

## Terraform Guidelines

- Use modules for reusable infrastructure
- Keep Function Apps identical except for configuration
- Enable Application Insights for all Function Apps
- Use consumption plan by default (cost-effective)
- Document all variables with descriptions

## Documentation

- Update docs/QUICKSTART.md for user-facing changes
- Update README.md for architectural changes
- Keep inline comments for complex logic only
- Document all public APIs with XML comments

## Security

- Never log refresh tokens or secrets
- Use Key Vault references for all sensitive data
- Grant minimum necessary Graph API permissions
- Review Azure AD sign-in logs regularly
- Rotate secrets every 6-12 months

## Performance

- Process files in batches to avoid timeouts
- Use MaxFilesPerRun to limit processing on Consumption Plan
- Stream large files instead of loading into memory
- Consider Premium Plan for >10,000 files

## Commit Message Guidelines

Always use conventional commit format:
- feat: new feature
- fix: bug fix
- docs: documentation changes
- style: formatting, missing semicolons, etc.
- refactor: code restructuring
- test: adding tests
- chore: maintenance tasks
- ci: CI/CD changes

Format: <type>(<scope>): <description>

Examples:
- feat(sync): add support for HEIC image format
- fix(auth): handle token refresh failures gracefully
- docs(setup): update refresh token instructions
- test(state): add integration tests for StateManager
- ci(github): skip workflows on documentation changes