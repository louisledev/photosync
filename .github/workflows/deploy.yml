name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  OUTPUT_PATH: 'output'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') || github.event_name == 'workflow_dispatch' }}
    concurrency:
      group: photosync-production-deployment
      cancel-in-progress: false
    environment:
      name: production

    steps:
      - name: Find latest successful build run
        if: github.event_name == 'workflow_dispatch'
        id: find-run
        uses: actions/github-script@v7
        with:
          script: |
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-test.yml',
              branch: 'main',
              status: 'success',
              per_page: 1
            });
            if (runs.data.workflow_runs.length === 0) {
              core.setFailed('No successful build runs found on main branch');
              return;
            }
            const runId = runs.data.workflow_runs[0].id;
            core.setOutput('run_id', runId);
            console.log(`Found latest successful build run: ${runId}`);

      - name: Download artifact from build job
        uses: actions/download-artifact@v7
        with:
          name: function-app
          path: ${{ env.OUTPUT_PATH }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event_name == 'workflow_dispatch' && steps.find-run.outputs.run_id || github.event.workflow_run.id }}

      - name: Verify downloaded artifact contents
        run: |
          echo "Contents of downloaded artifact:"
          ls -la ${{ env.OUTPUT_PATH }}
          echo ""
          echo "Full directory tree:"
          find ${{ env.OUTPUT_PATH }} -maxdepth 2 -ls || true
          echo ""
          echo "Checking for .azurefunctions folder:"
          if [ -d "${{ env.OUTPUT_PATH }}/.azurefunctions" ]; then
            echo "✓ .azurefunctions folder found"
            ls -la ${{ env.OUTPUT_PATH }}/.azurefunctions
          else
            echo "✗ .azurefunctions folder not found"
            echo "Looking for any .azurefunctions anywhere:"
            find ${{ env.OUTPUT_PATH }} -name ".azurefunctions" -type d || true
          fi

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Function App Source 1
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTIONAPP_SOURCE1_NAME }}
          package: ${{ env.OUTPUT_PATH }}

      - name: Deploy to Function App Source 2
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTIONAPP_SOURCE2_NAME }}
          package: ${{ env.OUTPUT_PATH }}
