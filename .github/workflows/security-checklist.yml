name: Security Best Practices Check

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  security-checklist:
    name: Verify Security Best Practices
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."

          # Check for common secret patterns (excluding test files and tfvars which are gitignored)
          ISSUES=0

          # Check for potential API keys
          if grep -r -i --include="*.cs" --include="*.json" "api[_-]key" . 2>/dev/null | grep -v "// "; then
            echo "::warning::Potential API key found in code"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for potential passwords
          if grep -r --include="*.cs" --include="*.json" '"password":\s*"[^{]' . 2>/dev/null; then
            echo "::warning::Potential hardcoded password found"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for connection strings
          if grep -r --include="*.cs" "ConnectionString.*=" . 2>/dev/null | grep -v "Configuration\[" | grep -v "//"; then
            echo "::warning::Potential hardcoded connection string found"
            ISSUES=$((ISSUES + 1))
          fi

          if [ $ISSUES -eq 0 ]; then
            echo "✓ No obvious hardcoded secrets found"
          else
            echo "::error::Found $ISSUES potential security issues. Review the warnings above."
            exit 1
          fi

      - name: Check for security headers
        run: |
          echo "Checking for security configurations..."

          # Check if HTTPS is enforced
          if ! grep -r "UseHttpsRedirection" src/ 2>/dev/null; then
            echo "::notice::Consider adding HTTPS redirection for production"
          fi

          echo "✓ Security configuration check complete"

      - name: Verify sensitive files are gitignored
        run: |
          echo "Verifying .gitignore includes sensitive files..."

          REQUIRED_IGNORES=(
            "local.settings.json"
            "*.tfvars"
            "*.tfstate"
            ".env"
            "appsettings.Development.json"
          )

          MISSING=0
          for pattern in "${REQUIRED_IGNORES[@]}"; do
            if ! grep -q "$pattern" .gitignore 2>/dev/null; then
              echo "::warning::$pattern should be in .gitignore"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -eq 0 ]; then
            echo "✓ All sensitive file patterns are gitignored"
          else
            echo "::error::$MISSING sensitive file patterns missing from .gitignore"
            exit 1
          fi

      - name: Check dependency licenses
        run: |
          echo "Checking for problematic licenses..."
          echo "✓ License check complete (handled by dependency-review action)"

      - name: Verify minimal permissions
        run: |
          echo "Checking Azure resource configurations..."

          # Check that Function App uses managed identity
          if grep -r "DefaultAzureCredential" src/ >/dev/null 2>&1; then
            echo "✓ Using DefaultAzureCredential (Managed Identity)"
          else
            echo "::warning::Consider using Managed Identity for Azure resources"
          fi

          echo "✓ Permission check complete"

      - name: Security Report
        if: always()
        run: |
          echo "## Security Checklist Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Hardcoded secrets check" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security headers verification" >> $GITHUB_STEP_SUMMARY
          echo "✅ Gitignore validation" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependency license check" >> $GITHUB_STEP_SUMMARY
          echo "✅ Minimal permissions check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Azure Security Center](https://portal.azure.com/#blade/Microsoft_Azure_Security/SecurityMenuBlade/0) for runtime security recommendations" >> $GITHUB_STEP_SUMMARY
