name: Security Scanning

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan every Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  dependency-review:
    name: Dependency & License Review
    runs-on: ubuntu-latest
    # Only run on pull requests - action requires base/head comparison
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0, GPL-2.0-only, GPL-3.0-only, AGPL-3.0, AGPL-3.0-only, LGPL-2.1, LGPL-3.0, LGPL-2.1-only, LGPL-3.0-only, MPL-2.0, EPL-1.0, EPL-2.0, CDDL-1.0, CDDL-1.1, CPL-1.0, OSL-3.0, EUPL-1.2, CC-BY-SA-4.0

  vulnerability-scan:
    name: NuGet Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore PhotoSync.sln

      - name: Scan for vulnerable packages
        run: |
          echo "Scanning for known vulnerabilities in NuGet packages..."
          dotnet list PhotoSync.sln package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt

          # Check if vulnerabilities were found
          if grep -q "has the following vulnerable packages" vulnerability-report.txt; then
            echo "::error::Vulnerable packages detected!"
            cat vulnerability-report.txt
            exit 1
          else
            echo "âœ“ No known vulnerabilities found"
          fi

      - name: Upload vulnerability report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: vulnerability-report
          path: vulnerability-report.txt

  iac-scanning:
    name: Infrastructure as Code Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run Microsoft Security DevOps
        uses: microsoft/security-devops-action@08976cb623803b1b36d7112d4ff9f59eae704de0 # v1.12.0
        id: msdo
        with:
          categories: 'IaC'

      - name: Upload results to Security tab
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.msdo.outputs.sarifFile }}
