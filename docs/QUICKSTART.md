# Quick Start Guide - Photo Sync (Personal Accounts)

This guide will get you up and running with **personal Microsoft accounts** (outlook.com, hotmail.com, live.com).

## Prerequisites Checklist

- [ ] Azure subscription ([Get free trial](https://azure.microsoft.com/free/))
- [ ] .NET 8.0 SDK installed
- [ ] Azure Functions Core Tools installed
- [ ] Terraform installed
- [ ] Azure CLI installed
- [ ] Node.js 18+ installed (for refresh token script)
- [ ] Access to the personal Microsoft accounts you want to sync

## Step-by-Step Setup

### 1. Configure Terraform (5 minutes)

```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your values:

```hcl
subscription_id               = "your-azure-subscription-id"
resource_group_name           = "photosync-rg"
function_app_name_prefix      = "photosync"
storage_account_name_prefix   = "photosync"
location                      = "westeurope"
enable_keyvault               = true
key_vault_name                = "photosync-kv-UNIQUE"  # Change UNIQUE to something random

# OneDrive configurations - ClientId is auto-generated by Terraform
onedrive1_config = {
  "OneDrive1:SourceFolder"           = "/Photos"
  "OneDrive1:RefreshTokenSecretName" = "source1-refresh-token"
  "OneDrive1:ClientSecretName"       = "source1-client-secret"
  "OneDrive1:DeleteAfterSync"        = "false"
  "OneDrive1:MaxFilesPerRun"         = "100"
}

onedrive2_config = {
  "OneDrive2:SourceFolder"           = "/Pictures"
  "OneDrive2:RefreshTokenSecretName" = "source2-refresh-token"
  "OneDrive2:ClientSecretName"       = "source2-client-secret"
  "OneDrive2:DeleteAfterSync"        = "false"
  "OneDrive2:MaxFilesPerRun"         = "100"
}

onedrive_destination_config = {
  "OneDriveDestination:RefreshTokenSecretName" = "destination-refresh-token"
  "OneDriveDestination:ClientSecretName"       = "destination-client-secret"
  "OneDriveDestination:DestinationFolder"      = "/Synced Photos"
}

# Leave empty for now - we'll fill these in after step 3
source1_refresh_token      = ""
source2_refresh_token      = ""
destination_refresh_token  = ""
```

### 2. Deploy Infrastructure (5 minutes)

```bash
# Login to Azure with Microsoft Graph permissions
az login --scope https://graph.microsoft.com/.default

# Set subscription ID environment variable
export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

# Deploy with Terraform
cd terraform
terraform init
terraform apply
```

Type `yes` when prompted. This creates:
- Azure AD App Registration (automatically configured)
- Client secret (auto-generated)
- Two Function Apps (one for each source account)
- Azure Key Vault (for refresh tokens and secrets)
- Storage accounts (for state tracking)
- Application Insights (for monitoring)

### 3. Get Refresh Tokens (10 minutes)

After Terraform completes, run the provided script to get refresh tokens:

```bash
# From the project root directory
cd ..
node tools/get-refresh-token.js \
  $(terraform -chdir=terraform output -raw onedrive_app_client_id) \
  $(terraform -chdir=terraform output -raw onedrive_app_client_secret)
```

**What happens:**
1. Browser opens automatically
2. Sign in with the first Microsoft account
3. Grant permissions when prompted
4. Copy the refresh token from terminal output
5. Save it securely

**Repeat for all 3 accounts:**
- Your personal account -> save as `source1_refresh_token`
- Second account -> save as `source2_refresh_token`
- Shared destination account -> save as `destination_refresh_token`

### 4. Update Terraform with Tokens (2 minutes)

Edit `terraform.tfvars` and paste the refresh tokens:

```hcl
source1_refresh_token      = "M.C553_BAY..."  # Your token
source2_refresh_token      = "M.C558_BAY..."  # Second account token
destination_refresh_token  = "M.C505_BAY..."  # Shared token
```

Apply to store tokens in Key Vault:

```bash
cd terraform
terraform apply
```

### 5. Deploy Function Code

Deployment happens automatically via **GitHub Actions** when you push to `main`:
1. Build and Test workflow runs
2. Deploy workflow deploys to both Function Apps

To trigger manually: **Actions** → **Deploy to Azure** → **Run workflow**

**For local deployment** (optional):
```bash
SOURCE1=$(terraform output -raw function_app_source1_name)
SOURCE2=$(terraform output -raw function_app_source2_name)
cd ../src
func azure functionapp publish $SOURCE1
func azure functionapp publish $SOURCE2
```

## Done!

Your PhotoSync is now running with personal Microsoft accounts.

## Verification

### Check Logs

View logs in Application Insights:

```bash
# Get the Application Insights logs URL
cd terraform
terraform output logs_portal_url
```

You can also query logs using KQL:
```kql
traces
| where timestamp > ago(1h)
| where cloud_RoleName contains "photosync"
| order by timestamp desc
| project timestamp, message, severityLevel
```

### Verify Photos

1. Check your destination OneDrive account (sign in at onedrive.com)
2. Navigate to the destination folder (e.g., `/Synced Photos`)
3. Look for photos organized by date: `YYYY/YYYY-MM/YYYYMMDD_HHMMSS.jpg`

## Schedule

The function runs automatically every hour. To change:
1. Open `PhotoSyncFunction.cs`
2. Change the cron expression: `[TimerTrigger("0 0 * * * *")]`

Examples:
- Every 6 hours: `"0 0 */6 * * *"`
- Every day at 8 PM: `"0 0 20 * * *"`
- Twice daily (6 AM & 6 PM): `"0 0 6,18 * * *"`

## Useful Terraform Outputs

```bash
# Get OneDrive app credentials (for refresh token script)
terraform output onedrive_app_client_id
terraform output -raw onedrive_app_client_secret

# Get the full command to generate refresh tokens
terraform output refresh_token_command

# Get Function App names
terraform output function_app_source1_name
terraform output function_app_source2_name

# Get monitoring URLs
terraform output logs_portal_url
```

## Troubleshooting

### "Insufficient privileges" during Terraform apply

Re-authenticate with Graph permissions:
```bash
az login --scope https://graph.microsoft.com/.default
```

### "Refresh token is invalid or expired"

Regenerate the token:
```bash
node tools/get-refresh-token.js \
  $(terraform -chdir=terraform output -raw onedrive_app_client_id) \
  $(terraform -chdir=terraform output -raw onedrive_app_client_secret)
```
Then update `terraform.tfvars` and run `terraform apply`.

### "Failed to retrieve refresh token from Key Vault"

- Ensure refresh tokens are set in `terraform.tfvars`
- Run `terraform apply` to update Key Vault
- Check Function App managed identity has Key Vault access (Terraform handles this)

### No photos syncing

- Check Function App logs for specific errors
- Verify source folders contain photos
- Ensure folder paths are correct (relative to OneDrive root)
- Check that photos have supported extensions (.jpg, .png, .heic, etc.)

## Cost

For typical use (500 photos/month with 2 Function Apps):
- Azure Functions (2 apps): ~$0.40/month
- Storage (2 accounts): ~$0.10/month
- Key Vault: ~$0.10/month
- Data transfer: ~$1-2/month

**Total: ~$2.50-3/month**

## How It Works

1. **Terraform-Managed App Registration**: Azure AD app created automatically
2. **Auto-Generated Client Secret**: Rotated by Terraform
3. **Delegated Permissions**: Each user consents when getting their refresh token
4. **Refresh Tokens**: Long-lived (~90 days), stored in Key Vault, auto-renew on use
5. **Managed Identities**: Function Apps access Key Vault securely
6. **User Control**: Users can revoke access anytime via Microsoft account settings

## Next Steps

- Monitor logs for the next few days
- Verify photos are syncing correctly with date-based folders
- See [PERSONAL_ACCOUNTS_SETUP.md](PERSONAL_ACCOUNTS_SETUP.md) for detailed documentation
- Check [README.md](../README.md) for customization options
